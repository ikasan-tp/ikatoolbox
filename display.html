<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IKATOOLBOX | Display Generator</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü¶ë</text></svg>">
    
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&family=Montserrat:wght@700;900&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --accent-color: #C5373C; --bg-rgb: 5, 5, 5; --bg-color: #050505; 
            --text-color: #ffffff; --sub-text-color: #888888; --border-color: rgba(255,255,255,0.1);
            --img-x: 0px; --img-y: 0px; --img-scale: 1;
            --v-x: 0px; --v-y: 0px; --v-scale: 1; --stat-max: 100;
            --ui-accent: #C5373C; --ui-bg: #222222; --ui-input: #111111; --ui-border: #444444;
        }

        body { background: #1a1a1a; color: #eee; margin: 0; display: flex; font-family: 'Montserrat', 'Noto Sans JP', sans-serif; height: 100vh; overflow: hidden; }
        
        /* UI Sidebar */
        .sidebar { 
            width: 420px; background: var(--ui-bg); border-right: 1px solid var(--ui-border); 
            flex-shrink: 0; display: flex; flex-direction: column; 
            transition: transform 0.3s ease; z-index: 2000;
        }
        .sidebar-scroll { flex: 1; overflow-y: auto; padding: 25px 20px; }

        .back-link { display: flex; align-items: center; gap: 8px; text-decoration: none; color: #888; font-size: 0.7rem; font-weight: 700; transition: 0.3s; margin-bottom: 20px; }
        .back-link:hover { color: var(--ui-accent); transform: translateX(-3px); }
        .ui-header { margin-bottom: 30px; border-bottom: 2px solid var(--ui-accent); padding-bottom: 15px; }
        .ui-brand { font-size: 0.7rem; font-weight: 900; color: var(--ui-accent); letter-spacing: 0.4em; display: block; margin-bottom: 2px; }
        .ui-title { font-size: 1.4rem; font-weight: 900; color: #fff; letter-spacing: 0.05em; display: flex; align-items: center; gap: 8px; }

        .control-group { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #333; }
        h2 { font-size: 0.75rem; color: #aaa; margin-bottom: 12px; letter-spacing: 0.05em; font-weight: 700; text-transform: uppercase; }
        label { display: block; font-size: 0.65rem; margin-bottom: 2px; color: #777; font-weight: bold; }
        textarea, input, select { width: 100%; background: var(--ui-input); border: 1px solid var(--ui-border); color: #fff; padding: 6px 8px; border-radius: 4px; font-size: 0.8rem; box-sizing: border-box; font-family: inherit; margin-bottom: 6px; }
        
        .skill-manager { background: var(--ui-input); border: 1px solid var(--ui-border); border-radius: 4px; max-height: 200px; overflow-y: auto; padding: 2px; margin-top: 5px; }
        .skill-manage-item { display: flex; align-items: center; padding: 6px 8px; border-bottom: 1px solid #222; cursor: pointer; transition: background 0.2s; }
        .skill-manage-item:hover { background: #2a2a2a; }
        .skill-manage-item input[type="checkbox"] { appearance: none; -webkit-appearance: none; width: 16px; height: 16px; border: 2px solid #555; border-radius: 3px; margin-right: 10px; cursor: pointer; position: relative; flex-shrink: 0; }
        .skill-manage-item input[type="checkbox"]:checked { background: var(--ui-accent); border-color: var(--ui-accent); }
        .skill-manage-item input[type="checkbox"]:checked::after { content: "‚úî"; position: absolute; color: white; font-size: 10px; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .skill-manage-item label { color: #eee; font-size: 0.75rem; cursor: pointer; margin-bottom: 0; flex-grow: 1; }

        .grid-flex { display: flex; gap: 8px; flex-wrap: wrap; }
        .grid-flex > div { flex: 1; min-width: 80px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        
        .theme-btn, .edition-btn { flex: 1; padding: 8px; cursor: pointer; border: 1px solid var(--ui-border); background: var(--ui-input); color: #888; font-size: 0.7rem; font-weight: bold; border-radius: 4px; }
        .theme-btn.active, .edition-btn.active { background: #444; color: #fff; border-color: #666; }
        .save-btn { width: 100%; padding: 18px; background: var(--ui-accent); color: white; border: none; border-radius: 4px; font-weight: 900; font-size: 1rem; cursor: pointer; margin-top: 10px; transition: 0.3s; letter-spacing: 0.2em; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }

        /* Preview Area */
        .preview-area { flex: 1; display: flex; justify-content: center; align-items: center; background: #151515; padding: 20px; overflow: auto; position: relative; }
        #display-canvas { width: 800px; height: 800px; background: var(--bg-color); color: var(--text-color); display: flex; position: relative; overflow: hidden; flex-shrink: 0; }
        #display-canvas::before { content: "‚ú¶"; position: absolute; top: 25%; left: 75%; transform: translate(-50%, -50%); font-size: 850px; color: var(--accent-color); opacity: 0.05; z-index: 0; pointer-events: none; }

        .info-side { flex: 0 0 75%; padding: 45px 50px; display: flex; flex-direction: column; z-index: 10; background: linear-gradient(to right, rgba(var(--bg-rgb), 1) 0%, rgba(var(--bg-rgb), 1) 50%, rgba(var(--bg-rgb), 0.8) 65%, rgba(var(--bg-rgb), 0) 85%); box-sizing: border-box; position: relative; }
        .scenario-tag { align-self: flex-start; background: var(--accent-color); color: #fff; font-size: 0.7rem; font-weight: 900; padding: 4px 12px; margin-bottom: 10px; height: 1.2rem; display: flex; align-items: center; }
        .name-area { border-left: 10px solid var(--accent-color); padding-left: 20px; display: flex; flex-direction: column; justify-content: center; width: 100%; min-height: 100px; margin-bottom: 5px; }
        
        ruby { display: flex; flex-direction: column-reverse; width: 100%; align-items: flex-start; }
        rt { font-size: 0.85rem; letter-spacing: 0.3em; color: var(--accent-color); margin-bottom: 2px; font-weight: 700; text-transform: uppercase; text-align: left; }
        #d-name-main { font-size: 3.8rem; font-weight: 900; line-height: 1; white-space: nowrap; transform-origin: left center; }
        .profile-sub { font-size: 0.85rem; color: var(--sub-text-color); margin-top: 8px; }
        .traits-display { font-size: 0.75rem; font-weight: 700; color: var(--accent-color); margin: 5px 0 0 20px; min-height: 1.2em; opacity: 0.9; }

        .variants-row { display: flex; gap: 10px; margin: 15px 0 20px 0; height: 85px; }
        .v-slot { width: 85px; height: 85px; background: rgba(var(--bg-rgb), 0.2); border: 1px solid var(--border-color); overflow: hidden; position: relative; }
        .v-slot img { position: absolute; left: 50%; top: 50%; width: 100%; transform: translate(calc(-50% + var(--v-x)), calc(-50% + var(--v-y))) scale(var(--v-scale)); object-fit: contain; display: none;}

        .status-grid { display: grid; grid-template-columns: repeat(2, 160px); gap: 12px 40px; margin-bottom: 12px; }
        .stat-val-header { display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; font-weight: 900; margin-bottom: 4px; }
        .stat-label { color: var(--sub-text-color); }
        .stat-bar-bg { height: 2px; background: var(--border-color); width: 100%; }
        .stat-bar-fill { height: 100%; background: var(--accent-color); transition: 0.6s ease-out; }

        .sub-stats { display: flex; gap: 10px; margin-bottom: 15px; width: 360px; }
        .sub-badge { flex: 1; padding: 10px 2px; background: rgba(var(--bg-rgb), 0.3); border-left: 3px solid var(--accent-color); text-align: center; }
        .sub-label { font-size: 0.6rem; color: var(--sub-text-color); font-weight: 700; display: block; }
        .sub-val { font-size: 1.3rem; font-weight: 900; line-height: 1; }

        .skills-container { padding-top: 5px; flex-grow: 1; width: 100%; max-width: 370px; margin-left: -10px; }
        .skills-header { display: flex; align-items: center; gap: 10px; font-size: 0.85rem; font-weight: 900; color: var(--accent-color); margin-bottom: 12px; letter-spacing: 0.2em; }
        .skills-header::after { content: ""; flex: 1; height: 1px; background: var(--accent-color); opacity: 0.4; }
        #skills-list { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px 15px; }
        .skill-item { font-size: 0.7rem; display: flex; justify-content: flex-start; gap: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 2px; }
        .skill-check { width: 7px; height: 7px; border: 1.5px solid var(--accent-color); flex-shrink: 0; }
        .skill-val { color: var(--accent-color); font-weight: 900; margin-left: auto; }

        .image-side { position: absolute; right: 0; top: 0; width: 100%; height: 100%; z-index: 1; display: flex; justify-content: flex-end; align-items: flex-end; overflow: hidden; }
        /* ËÉåÊôØ„ÅÆ„Ç¢„ÇØ„Çª„É≥„Éà„ÇíÂº∑Ë™øÔºà‰∏çÈÄèÊòéÂ∫¶ 0.5 -> 0.7Ôºâ */
        .accent-bg { 
            position: absolute; top: 0; right: 0; width: 100%; height: 100%; 
            background: radial-gradient(circle at 110% 100%, var(--accent-color) 0%, transparent 70%); 
            opacity: 0.7; z-index: 1; pointer-events: none; 
        }
        #main-img { height: 98%; z-index: 2; transform: translate(var(--img-x), var(--img-y)) scale(var(--img-scale)); display: none; pointer-events: none; }

        .file-input-wrapper { position: relative; margin-bottom: 10px; }
        .file-input-wrapper input[type="file"] { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        .custom-file-btn { display: flex; align-items: center; justify-content: center; gap: 8px; background: var(--ui-input); border: 1px dashed var(--ui-border); color: #aaa; padding: 10px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; transition: 0.2s; cursor: pointer; }
        .custom-file-btn:hover { border-color: var(--ui-accent); color: #fff; background: #222; }
        .custom-file-btn.mini { padding: 6px; font-size: 0.65rem; }
        
        input[type="range"] { -webkit-appearance: none; appearance: none; background: transparent; cursor: pointer; width: 100%; height: 20px; margin: 0; }
        input[type="range"]::-webkit-slider-runnable-track { background: #333; height: 4px; border-radius: 2px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; margin-top: -6px; background-color: var(--ui-accent); height: 16px; width: 8px; border-radius: 2px; box-shadow: 0 0 10px rgba(197, 55, 60, 0.4); transition: 0.2s; }
        input[type="range"]:hover::-webkit-slider-thumb { filter: brightness(1.2); transform: scaleX(1.5); }

        .mobile-menu-btn {
            position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px; border-radius: 50%;
            background: var(--ui-accent); color: white; display: none; align-items: center; justify-content: center;
            border: none; z-index: 3000; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        @media screen and (max-width: 1024px) {
            .mobile-menu-btn { display: flex; }
            .sidebar { position: fixed; left: 0; top: 0; height: 100vh; transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
            #display-canvas { transform: scale(0.45); transform-origin: center center; }
            .preview-area { padding: 0; overflow: hidden; }
        }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-scroll">
        <a href="index.html" class="back-link">
            <span class="material-symbols-outlined" style="font-size: 1rem;">arrow_back_ios</span>
            BACK TO TOOLBOX
        </a>
        <div class="ui-header"><span class="ui-brand">IKATOOLBOX</span><div class="ui-title">DISPLAY GENERATOR</div></div>

        <div class="control-group">
            <h2>1. „Éá„Éº„ÇøÂèñ„ÇäËæº„Åø</h2>
            <textarea id="json-input" placeholder="Èßí„Éá„Éº„Çø„ÇíË≤º„Çä‰ªò„Åë" oninput="importData()"></textarea>
            <div class="grid-2">
                <button id="btn-7th" class="edition-btn active" onclick="setEdition(7)">7Áâà</button>
                <button id="btn-6th" class="edition-btn" onclick="setEdition(6)">6Áâà</button>
            </div>
        </div>

        <div class="control-group">
            <h2>2. „Éó„É≠„Éï„Ç£„Éº„É´</h2>
            <div class="grid-2">
                <div><label>ÂêçÂâç</label><input type="text" id="in-name" oninput="updateNameDisp()"></div>
                <div><label>„Éï„É™„Ç¨„Éä</label><input type="text" id="in-ruby" oninput="updateRubyDisp()"></div>
            </div>
            <div><label>„Ç∑„Éä„É™„Ç™</label><input type="text" id="in-scenario" oninput="refreshScenarioDisplay()"></div>
            <div class="grid-3">
                <div><label>Âπ¥ÈΩ¢</label><input type="text" id="in-age" oninput="refreshProfileDisplay()"></div>
                <div><label>ÊÄßÂà•</label><input type="text" id="in-sex" oninput="refreshProfileDisplay()"></div>
                <div><label>ËÅ∑Ê•≠</label><input type="text" id="in-job" oninput="refreshProfileDisplay()"></div>
            </div>
            <div class="grid-2" style="margin-top:5px;">
                <div><label>ÁâπÂæ¥1</label><input type="text" id="in-t1-name" oninput="updateTrait()"></div>
                <div><label>ÁâπÂæ¥2</label><input type="text" id="in-t2-name" oninput="updateTrait()"></div>
            </div>
        </div>

        <div class="control-group">
            <h2>3. „Çπ„ÉÜ„Éº„Çø„Çπ & ÊäÄËÉΩ</h2>
            <div class="grid-flex">
                <div><label>STR</label><input type="number" id="in-str" oninput="setBar('str', this.value)"></div>
                <div><label>CON</label><input type="number" id="in-con" oninput="setBar('con', this.value)"></div>
                <div><label>POW</label><input type="number" id="in-pow" oninput="setBar('pow', this.value)"></div>
                <div><label>DEX</label><input type="number" id="in-dex" oninput="setBar('dex', this.value)"></div>
            </div>
            <div class="grid-flex">
                <div><label>APP</label><input type="number" id="in-app" oninput="setBar('app', this.value)"></div>
                <div><label>SIZ</label><input type="number" id="in-siz" oninput="setBar('siz', this.value)"></div>
                <div><label>INT</label><input type="number" id="in-int" oninput="setBar('int', this.value)"></div>
                <div><label>EDU</label><input type="number" id="in-edu" oninput="setBar('edu', this.value)"></div>
            </div>
            <div class="grid-flex" style="margin-top:10px;">
                <div><label>SAN</label><input type="number" id="in-san" oninput="updateVal('d-san', this.value, '0')"></div>
                <div><label>LUK</label><input type="number" id="in-luk" oninput="updateVal('d-luk', this.value, '0')"></div>
                <div><label>HP</label><input type="number" id="in-hp" oninput="updateVal('d-hp', this.value, '0')"></div>
                <div><label>MP</label><input type="number" id="in-mp" oninput="updateVal('d-mp', this.value, '0')"></div>
            </div>
            <div style="margin-top:10px;">
                <div class="grid-2">
                    <div><label>Ë°®Á§∫Êï∞</label><input type="number" id="skill-limit" value="16" oninput="refreshSkills()"></div>
                    <div><label>„ÇΩ„Éº„Éà</label><select id="skill-sort" onchange="refreshSkills()"><option value="desc">È´ò„ÅÑÈ†Ü</option><option value="none">ÁôªÈå≤È†Ü</option></select></div>
                </div>
                <div id="skill-manager-list" class="skill-manager"></div>
            </div>
        </div>

        <div class="control-group">
            <h2>4. Á´ã„Å°ÁµµË™øÊï¥</h2>
            <label>„É°„Ç§„É≥Á´ã„Å°Áµµ</label>
            <div class="file-input-wrapper">
                <label for="main-file" class="custom-file-btn"><span class="material-symbols-outlined">image</span> ÁîªÂÉè„ÇíÈÅ∏Êäû</label>
                <input type="file" id="main-file" onchange="loadImg(this, 'main-img')">
            </div>
            <div class="grid-3">
                <div><label>Â∑¶Âè≥</label><input type="range" min="-600" max="600" value="0" oninput="setPos('--img-x', this.value)"></div>
                <div><label>‰∏ä‰∏ã</label><input type="range" min="-600" max="600" value="0" oninput="setPos('--img-y', this.value)"></div>
                <div><label>Êã°Â§ß</label><input type="range" min="0.1" max="4" step="0.01" value="1" oninput="setPos('--img-scale', this.value)"></div>
            </div>
            <label style="margin-top:10px;">Â∑ÆÂàÜ„Çπ„É≠„ÉÉ„Éà (1~3)</label>
            <div class="grid-3">
                <div class="file-input-wrapper">
                    <label for="v1-file" class="custom-file-btn mini">#1</label>
                    <input type="file" id="v1-file" onchange="loadImg(this, 'v1-img')">
                </div>
                <div class="file-input-wrapper">
                    <label for="v2-file" class="custom-file-btn mini">#2</label>
                    <input type="file" id="v2-file" onchange="loadImg(this, 'v2-img')">
                </div>
                <div class="file-input-wrapper">
                    <label for="v3-file" class="custom-file-btn mini">#3</label>
                    <input type="file" id="v3-file" onchange="loadImg(this, 'v3-img')">
                </div>
            </div>
            <div class="grid-3">
                <div><label>Â∑¶Âè≥</label><input type="range" min="-150" max="150" value="0" oninput="setPos('--v-x', this.value)"></div>
                <div><label>‰∏ä‰∏ã</label><input type="range" min="-150" max="150" value="0" oninput="setPos('--v-y', this.value)"></div>
                <div><label>Êã°Â§ß</label><input type="range" min="0.1" max="5" step="0.01" value="1" oninput="setPos('--v-scale', this.value)"></div>
            </div>
        </div>

        <div class="control-group">
            <h2>5. „Ç´„Çπ„Çø„Éû„Ç§„Ç∫</h2>
            <label>„Ç≠„É£„É≥„Éê„ÇπËÉåÊôØ</label>
            <div class="grid-2" style="margin-bottom:10px;">
                <button id="btn-dark" class="theme-btn active" onclick="setCanvasTheme('dark')">DARK</button>
                <button id="btn-light" class="theme-btn" onclick="setCanvasTheme('light')">LIGHT</button>
            </div>
            <label>„Ç¢„ÇØ„Çª„É≥„Éà„Ç´„É©„Éº</label>
            <input type="color" id="color-picker" value="#C5373C" oninput="root.style.setProperty('--accent-color', this.value)" style="height:40px; cursor:pointer; border:none; width:100%; background:none;">
            <button class="save-btn" onclick="saveImage()">ÁîªÂÉè„Çí‰øùÂ≠ò„Åô„Çã</button>
        </div>
    </div>
</div>

<div class="preview-area">
    <div id="display-canvas">
        <div class="info-side">
            <div id="d-scenario" class="scenario-tag">CoC 7th: SCENARIO</div>
            <div class="name-area">
                <ruby><span id="d-name-main">NAME</span><rt id="d-name-ruby">INVESTIGATOR</rt></ruby>
                <div id="d-profile-line" class="profile-sub">- / - / -</div>
            </div>
            <div id="d-traits" class="traits-display"></div>
            <div class="variants-row">
                <div class="v-slot"><img id="v1-img"></div>
                <div class="v-slot"><img id="v2-img"></div>
                <div class="v-slot"><img id="v3-img"></div>
            </div>
            <div class="status-grid">
                <div class="stat-item"><div class="stat-val-header"><span class="stat-label">STR</span><span id="val-str">0</span></div><div class="stat-bar-bg"><div id="b-str" class="stat-bar-fill"></div></div></div>
                <div class="stat-item"><div class="stat-val-header"><span class="stat-label">CON</span><span id="val-con">0</span></div><div class="stat-bar-bg"><div id="b-con" class="stat-bar-fill"></div></div></div>
                <div class="stat-item"><div class="stat-val-header"><span class="stat-label">POW</span><span id="val-pow">0</span></div><div class="stat-bar-bg"><div id="b-pow" class="stat-bar-fill"></div></div></div>
                <div class="stat-item"><div class="stat-val-header"><span class="stat-label">DEX</span><span id="val-dex">0</span></div><div class="stat-bar-bg"><div id="b-dex" class="stat-bar-fill"></div></div></div>
                <div class="stat-item"><div class="stat-val-header"><span class="stat-label">APP</span><span id="val-app">0</span></div><div class="stat-bar-bg"><div id="b-app" class="stat-bar-fill"></div></div></div>
                <div class="stat-item"><div class="stat-val-header"><span class="stat-label">SIZ</span><span id="val-siz">0</span></div><div class="stat-bar-bg"><div id="b-siz" class="stat-bar-fill"></div></div></div>
                <div class="stat-item"><div class="stat-val-header"><span class="stat-label">INT</span><span id="val-int">0</span></div><div class="stat-bar-bg"><div id="b-int" class="stat-bar-fill"></div></div></div>
                <div class="stat-item"><div class="stat-val-header"><span class="stat-label">EDU</span><span id="val-edu">0</span></div><div class="stat-bar-bg"><div id="b-edu" class="stat-bar-fill"></div></div></div>
            </div>
            <div class="sub-stats">
                <div class="sub-badge"><span class="sub-label">SAN</span><span id="d-san" class="sub-val">0</span></div>
                <div class="sub-badge"><span class="sub-label">LUK</span><span id="d-luk" class="sub-val">0</span></div>
                <div class="sub-badge"><span class="sub-label">HP</span><span id="d-hp" class="sub-val">0</span></div>
                <div class="sub-badge"><span class="sub-label">MP</span><span id="d-mp" class="sub-val">0</span></div>
            </div>
            <div class="skills-container"><div class="skills-header">SKILLS</div><div id="skills-list"></div></div>
        </div>
        <div class="image-side"><div class="accent-bg"></div><img id="main-img"></div>
    </div>
</div>

<button id="menu-toggle" class="mobile-menu-btn"><span class="material-symbols-outlined">settings</span></button>

<script>
    const root = document.documentElement;
    let allSkills = [];

    document.getElementById('menu-toggle').onclick = function() {
        const sidebar = document.querySelector('.sidebar');
        sidebar.classList.toggle('active');
        this.querySelector('.material-symbols-outlined').textContent = 
            sidebar.classList.contains('active') ? 'close' : 'settings';
    };

    function setCanvasTheme(theme) {
        const isDark = theme === 'dark';
        root.style.setProperty('--bg-rgb', isDark ? '5, 5, 5' : '255, 255, 255');
        root.style.setProperty('--bg-color', isDark ? '#050505' : '#ffffff');
        root.style.setProperty('--text-color', isDark ? '#ffffff' : '#111111');
        root.style.setProperty('--sub-text-color', isDark ? '#888888' : '#666666');
        root.style.setProperty('--border-color', isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)');
        document.getElementById('btn-dark').classList.toggle('active', isDark);
        document.getElementById('btn-light').classList.toggle('active', !isDark);
    }

    function updateNameDisp() {
        const ni = document.getElementById('in-name'); 
        const ri = document.getElementById('in-ruby');
        const m = ni.value.match(/^(.+?)\s*[Ôºà(\[](.*?)[Ôºâ)\]]$/);
        if (m) { ni.value = m[1].trim(); ri.value = m[2].trim(); }
        document.getElementById('d-name-main').innerText = ni.value || 'NAME';
        updateRubyDisp();
    }

    function updateRubyDisp() {
        const ri = document.getElementById('in-ruby');
        document.getElementById('d-name-ruby').innerText = ri.value || 'INVESTIGATOR';
        adjustNameFontSize();
    }

    function updateTrait() {
        const t1 = document.getElementById('in-t1-name').value;
        const t2 = document.getElementById('in-t2-name').value;
        document.getElementById('d-traits').innerText = (t1 && t2) ? `${t1} / ${t2}` : (t1 || t2 || "");
    }

    function refreshProfileDisplay() {
        const a = document.getElementById('in-age').value || "-";
        const s = document.getElementById('in-sex').value || "-";
        const j = document.getElementById('in-job').value || "-";
        document.getElementById('d-profile-line').innerText = `${a} / ${s} / ${j}`;
        adjustNameFontSize();
    }

    function adjustNameFontSize() {
        const el = document.getElementById('d-name-main');
        let size = 3.8; el.style.fontSize = size + "rem";
        while (el.offsetWidth > 380 && size > 1.0) { size -= 0.1; el.style.fontSize = size + "rem"; }
    }

    function refreshScenarioDisplay() {
        const ed = document.getElementById('btn-7th').classList.contains('active') ? 7 : 6;
        document.getElementById('d-scenario').innerText = `CoC ${ed}th: ${document.getElementById('in-scenario').value || 'SCENARIO'}`;
    }

    function updateVal(id, v, d) { document.getElementById(id).innerText = v || d; }

    function importData() {
        try {
            const raw = document.getElementById('json-input').value;
            if(!raw) return;
            const d = (JSON.parse(raw)).data || JSON.parse(raw);
            if (d.color) { root.style.setProperty('--accent-color', d.color); document.getElementById('color-picker').value = d.color; }
            setEdition(d.commands && d.commands.includes("CCB") ? 6 : 7);
            document.getElementById('in-name').value = d.name || ""; 
            updateNameDisp();
            if (d.memo) {
                const rubyInput = document.getElementById('in-ruby');
                if (!rubyInput.value) {
                    const firstLine = d.memo.split('\n')[0];
                    const match = firstLine.match(/[Ôºà(](.+?)[Ôºâ)]/);
                    if (match && match[1]) { rubyInput.value = match[1].trim(); updateRubyDisp(); }
                }
                const profileLine = d.memo.split('\n')[2];
                if (profileLine && profileLine.includes('/')) {
                    const parts = profileLine.split('/').map(p => p.trim());
                    if (parts[0]) document.getElementById('in-age').value = parts[0];
                    if (parts[1]) document.getElementById('in-sex').value = parts[1];
                    refreshProfileDisplay();
                }
            }
            if (d.age) document.getElementById('in-age').value = d.age;
            if (d.sex) document.getElementById('in-sex').value = d.sex;
            if (d.job) document.getElementById('in-job').value = d.job;
            const ps = ["str","con","pow","dex","app","siz","int","edu"];
            if (d.params) d.params.forEach(p => {
                const l = p.label.toLowerCase();
                if(ps.includes(l)) { document.getElementById('in-'+l).value = p.value; setBar(l, p.value); }
            });
            const sm = {'hp':'hp','mp':'mp','san':'san','luck':'luk','Âπ∏ÈÅã':'luk'};
            if (d.status) d.status.forEach(s => {
                const id = sm[s.label.toLowerCase()] || sm[s.label];
                if(id) { document.getElementById('in-'+id).value = s.value; updateVal('d-'+id, s.value, '0'); }
            });
            allSkills = [];
            if (d.commands) {
                d.commands.split('\n').forEach(line => {
                    const m = line.match(/CCB?\(?.*?\)?<=?(\d+)\s+„Äê(.+?)„Äë/);
                    if (m) {
                        const v = parseInt(m[1]), l = m[2].trim();
                        if (["Áü•Ë≠ò", "„Ç¢„Ç§„Éá„Ç¢", "ÊØçÂõΩË™û"].includes(l)) return;
                        if (l === "Âπ∏ÈÅã") { document.getElementById('in-luk').value = v; updateVal('d-luk', v, '0'); }
                        else if (!sm[l.toLowerCase()] && !sm[l]) {
                            const isVisible = ["ÂõûÈÅø", "ÁõÆÊòü", "ËÅû„ÅçËÄ≥", "Âõ≥Êõ∏È§®"].includes(l) || v > 40;
                            allSkills.push({ label: l, value: v, visible: isVisible });
                        }
                    }
                });
            }
            allSkills = allSkills.filter((v, i, a) => a.findIndex(t => t.label === v.label) === i);
            buildSkillManager(); refreshSkills(); refreshScenarioDisplay(); refreshProfileDisplay();
        } catch (e) { console.error(e); alert("„Éá„Éº„ÇøÂΩ¢Âºè„Ç®„É©„Éº"); }
    }

    function buildSkillManager() {
        const c = document.getElementById('skill-manager-list'); c.innerHTML = "";
        allSkills.forEach((s, i) => {
            const div = document.createElement('div'); div.className = 'skill-manage-item';
            div.onclick = (e) => { if(e.target.tagName !== 'INPUT') { const cb = div.querySelector('input'); cb.checked = !cb.checked; allSkills[i].visible = cb.checked; refreshSkills(); } };
            div.innerHTML = `<input type="checkbox" id="sm-${i}" ${s.visible ? 'checked' : ''} onchange="allSkills[${i}].visible=this.checked;refreshSkills()"><label for="sm-${i}">${s.label}(${s.value})</label>`;
            c.appendChild(div);
        });
    }

    function refreshSkills() {
        const list = document.getElementById('skills-list'); list.innerHTML = "";
        const limit = parseInt(document.getElementById('skill-limit').value) || 16;
        let data = allSkills.filter(s => s.visible);
        if (document.getElementById('skill-sort').value === "desc") data.sort((a, b) => b.value - a.value);
        data.slice(0, limit).forEach(s => {
            const item = document.createElement('div'); item.className = 'skill-item';
            item.innerHTML = `<div style="display:flex;align-items:center;gap:6px;"><div class="skill-check"></div>${s.label}</div><span class="skill-val">${s.value}</span>`;
            list.appendChild(item);
        });
    }

    function setBar(id, val) {
        const max = parseInt(getComputedStyle(root).getPropertyValue('--stat-max'));
        const bar = document.getElementById('b-' + id);
        if(bar) bar.style.width = Math.min((val / max) * 100, 100) + '%';
        const num = document.getElementById('val-' + id); if(num) num.innerText = val;
    }

    function setPos(p, v) { root.style.setProperty(p, p.includes('scale') ? v : v + 'px'); }
    function loadImg(i, id) { const f = i.files[0]; if(f) { const el = document.getElementById(id); el.src = URL.createObjectURL(f); el.style.display = 'block'; } }
    
    function saveImage() { 
        const canvas = document.getElementById('display-canvas');
        /* ‰øÆÊ≠£ÁÆáÊâÄ: „Éï„Ç°„Ç§„É´Âêç„Çí„Ç≠„É£„É©„ÇØ„Çø„ÉºÂêç„Å´Â§âÊõ¥ */
        const charName = document.getElementById('in-name').value || 'investigator';
        
        html2canvas(canvas, { 
            scale: 2,
            useCORS: true,
            allowTaint: true,
            backgroundColor: getComputedStyle(root).getPropertyValue('--bg-color').trim(),
            onclone: (clonedDoc) => {
                const info = clonedDoc.querySelector('.info-side');
                const img = clonedDoc.querySelector('.image-side');
                const accent = clonedDoc.querySelector('.accent-bg');
                if(info) info.style.zIndex = "10";
                if(img) img.style.zIndex = "1";
                if(accent) {
                    accent.style.clipPath = "none";
                    accent.style.background = `radial-gradient(circle at 110% 100%, ${getComputedStyle(root).getPropertyValue('--accent-color')} 0%, transparent 70%)`;
                    accent.style.opacity = "0.7";
                }
            }
        }).then(c => { 
            const a = document.createElement('a'); 
            a.download = `${charName}.png`; 
            a.href = c.toDataURL('image/png'); 
            a.click(); 
        }); 
    }

    function setEdition(ed) {
        root.style.setProperty('--stat-max', ed === 7 ? 100 : 25);
        document.getElementById('btn-7th').classList.toggle('active', ed === 7);
        document.getElementById('btn-6th').classList.toggle('active', ed === 6);
        refreshScenarioDisplay();
        ["str","con","pow","dex","app","siz","int","edu"].forEach(id => { const v = document.getElementById('in-' + id).value; if(v) setBar(id, v); });
    }
</script>
</body>
</html>
