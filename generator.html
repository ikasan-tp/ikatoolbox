<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IKATOOLBOX | LOG EDITOR</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü¶ë</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&family=Montserrat:wght@700;900&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #1a1a1a;
            --card-bg: #222222;
            --ui-input: #111111;
            --ui-border: #444444;
            --accent: #C5373C;
            --text-main: #dbdee1;
            --text-sub: #b5bac1;
            --selection-bg: rgba(197, 55, 60, 0.15);
            --sidebar-width: 420px;
        }

        .material-symbols-outlined { vertical-align: middle; font-size: 1.1rem; }
        body { background: var(--bg-dark); color: var(--text-main); margin: 0; display: flex; font-family: 'Noto Sans JP', 'Montserrat', sans-serif; height: 100vh; overflow: hidden; }

        .sidebar { 
            width: var(--sidebar-width); 
            background: var(--card-bg); 
            border-right: 1px solid var(--ui-border); 
            display: flex; 
            flex-direction: column; 
            transition: transform 0.3s ease-out;
            z-index: 1000;
        }
        .sidebar-scroll { flex: 1; overflow-y: auto; padding: 25px 20px; }
        .sidebar-footer { padding: 20px; border-top: 1px solid var(--ui-border); background: var(--card-bg); }

        .back-link { display: flex; align-items: center; gap: 8px; text-decoration: none; color: #888; font-size: 0.7rem; font-weight: 700; transition: 0.3s; margin-bottom: 20px; }
        .back-link:hover { color: #C5373C; transform: translateX(-3px); }

        .ui-header { text-align: left; margin-bottom: 30px; border-bottom: 2px solid var(--accent); padding-bottom: 15px; }
        .ui-brand { font-family: 'Montserrat', sans-serif; font-size: 0.7rem; font-weight: 900; color: var(--accent); letter-spacing: 0.4em; display: block; margin-bottom: 2px; }
        .ui-title { font-family: 'Montserrat', sans-serif; font-size: 1.4rem; font-weight: 900; color: #fff; letter-spacing: 0.05em; display: flex; align-items: center; gap: 8px; }

        .control-group { margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #333; }
        h2 { font-size: 0.75rem; color: #aaa; margin-bottom: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; }
        
        input[type="text"] { width: 100%; background: var(--ui-input); border: 1px solid var(--ui-border); color: #fff; padding: 10px 12px; border-radius: 6px; font-size: 0.8rem; margin-bottom: 6px; box-sizing: border-box; }

        .input-with-extension { display: flex; align-items: center; background: var(--ui-input); border: 1px solid var(--ui-border); border-radius: 6px; overflow: hidden; margin-bottom: 6px; }
        .input-with-extension input { border: none; margin-bottom: 0; border-radius: 0; flex: 1; }
        .extension-label { padding: 0 12px; color: #555; font-family: 'Montserrat'; font-weight: 900; font-size: 0.75rem; letter-spacing: 0.05em; border-left: 1px solid #333; height: 100%; display: flex; align-items: center; }

        .file-input-area { border: 2px dashed #4f545c; padding: 30px 20px; border-radius: 8px; background: #313338; cursor: pointer; margin-bottom: 20px; text-align: center; }
        .file-label { color: var(--accent); text-decoration: underline; font-weight: bold; font-size: 0.85rem; }

        .group-panel { background: var(--accent); color: #fff; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .btn-wrap { display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap; }
        .group-panel button { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); color: #fff; padding: 6px 12px; border-radius: 4px; font-size: 0.7rem; cursor: pointer; font-weight: bold; transition: 0.2s; display: flex; align-items: center; gap: 4px; }
        .group-panel button:hover { background: rgba(0,0,0,0.6); }
        .btn-delete { color: #ff8a8a !important; border: 1px solid rgba(255, 138, 138, 0.3) !important; }

        .char-conf { background: var(--ui-input); border: 1px solid var(--ui-border); padding: 8px; border-radius: 4px; display: flex; align-items: center; gap: 6px; margin-bottom: 8px; }
        .in-color-picker { width: 24px; height: 24px; padding: 0; border: none; background: none; cursor: pointer; flex-shrink: 0; }
        .in-color-picker::-webkit-color-swatch-wrapper { padding: 0; }
        .in-color-picker::-webkit-color-swatch { border: 1px solid #444; border-radius: 2px; }
        .char-conf .in-name { flex: 1; background: transparent; border: none; color: #fff; font-size: 0.8rem; font-weight: bold; margin: 0; padding: 4px; }
        .char-conf .in-color { width: 75px; background: #222; border: 1px solid #444; color: #888; font-size: 0.7rem; padding: 4px; margin: 0; text-align: center; border-radius: 2px; }

        .tab-config-item { background: #111; border-radius: 4px; padding: 10px; margin-bottom: 8px; display: flex; flex-direction: column; gap: 8px; border: 1px solid #333; }
        .tab-config-top { display: flex; align-items: center; justify-content: space-between; }
        .tab-config-name { font-size: 0.75rem; font-weight: 900; color: #888; }
        .tab-config-controls { display: flex; align-items: center; gap: 8px; }
        .style-select { background: #222; color: #eee; border: 1px solid #444; border-radius: 4px; padding: 4px 8px; font-size: 0.7rem; }

        .search-box { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 6px; border: 1px solid #333; }
        .search-btns { display: flex; gap: 4px; margin-top: 4px; }
        .search-btns button { flex: 1; padding: 6px; background: #333; border: none; color: #fff; font-size: 0.65rem; border-radius: 4px; cursor: pointer; }
        .search-btns button:hover { background: #444; }

        .main-content { flex: 1; background: #0a0a0a; overflow-y: auto; padding: 40px 0; scroll-behavior: smooth; }
        .log-row { position: relative; width: 100%; max-width: 900px; margin: 0 auto; padding: 20px 15px; border-bottom: 1px solid #222; transition: 0.1s; border-left: 4px solid transparent; box-sizing: border-box; display: flex; flex-direction: column; gap: 12px; }
        .log-row.search-hit { outline: 2px solid rgba(255, 235, 59, 0.3); background: rgba(255, 235, 59, 0.05); }
        .log-row.preview-info, .log-row.preview-secret, .log-row.preview-chat { background: #151515; }
        .log-row.preview-chat .row-content { color: #555; }
        .log-row.preview-chat .row-name { opacity: 0.5; }
        .log-row.preview-info { border-left: 4px solid #444; }

        .col-select { display: flex; align-items: center; gap: 12px; padding-top: 10px; border-top: 1px dashed #333; }
        .row-checkbox { display: none; }
        .select-label { font-size: 0.65rem; font-weight: 900; color: #666; text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer; padding: 4px 10px; border: 1px solid #444; border-radius: 4px; transition: 0.2s; display: flex; align-items: center; gap: 6px; }
        .select-label::before { content: ''; display: inline-block; width: 8px; height: 8px; border: 1px solid #666; border-radius: 2px; }
        .row-checkbox:checked + .select-label { background: var(--accent); border-color: var(--accent); color: #fff; }
        .row-checkbox:checked + .select-label::before { background: #fff; border-color: #fff; }

        .action-group { margin-left: auto; display: flex; gap: 8px; }
        .move-btn { background: none; border: none; color: #555; cursor: pointer; padding: 4px; transition: 0.2s; border-radius: 4px; }
        .move-btn:hover { color: var(--accent); background: rgba(255,255,255,0.05); }
        .del-btn { background: none; border: none; color: #444; cursor: pointer; padding: 4px; transition: 0.2s; border-radius: 4px; }
        .del-btn:hover { color: #ff8a8a; background: rgba(255,255,255,0.05); }

        .row-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; gap: 10px; }
        .row-name { font-weight: bold; font-size: 1rem; flex-shrink: 0; }
        
        .anchor-area { display: flex; align-items: center; gap: 8px; flex: 1; justify-content: flex-end; }
        .anchor-check-label { font-size: 0.6rem; color: #555; display: flex; align-items: center; gap: 4px; cursor: pointer; }
        .anchor-input { background: rgba(255, 255, 255, 0.05) !important; border: 1px solid #333 !important; color: var(--accent) !important; font-size: 0.65rem !important; padding: 2px 8px !important; width: 180px !important; margin: 0 !important; display: none; }
        .anchor-check:checked + .anchor-input { display: block; }

	.row-content { width: 100%; background: transparent; border: none; color: #ccc; font-size: 0.95rem; line-height: 1.7; resize: none; overflow: hidden; white-space: pre-wrap; font-family: inherit; }
        mark { background: #ffeb3b; color: #000; border-radius: 2px; }

        .save-btn { width: 100%; padding: 16px; background: var(--accent); color: white; border: none; border-radius: 25px; font-weight: 900; cursor: pointer; letter-spacing: 0.1em; transition: 0.2s; }
        .save-btn:hover:not(:disabled) { filter: brightness(1.2); }
        .save-btn:disabled { background: #444; opacity: 0.5; }
        
        #emptyState { text-align: center; color: #444; margin-top: 60px; font-family: 'Noto Sans JP', sans-serif; }
        .guide-container { max-width: 600px; margin: 30px auto; text-align: left; background: #111; padding: 40px; border-radius: 12px; border: 1px solid #222; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .guide-welcome { margin-bottom: 30px; border-bottom: 1px solid #333; padding-bottom: 20px; }
        .guide-welcome h1 { font-family: 'Montserrat'; font-weight: 900; font-size: 1.8rem; color: #fff; margin: 0; letter-spacing: 0.05em; }
        .guide-welcome p { font-size: 0.8rem; color: var(--accent); font-weight: bold; margin: 5px 0 0; letter-spacing: 0.1em; }

        .guide-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .guide-item { margin-bottom: 10px; display: flex; gap: 15px; align-items: flex-start; }
        .guide-icon { color: var(--accent); padding-top: 2px; font-size: 1.4rem !important; }
        .guide-text b { color: #eee; font-size: 0.85rem; display: block; margin-bottom: 4px; }
        .guide-text p { font-size: 0.75rem; color: #777; margin: 0; line-height: 1.5; }

        .mobile-menu-btn { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 50%; background: var(--accent); color: white; border: none; z-index: 10001; cursor: pointer; display: none; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .mobile-menu-btn span { transition: transform 0.3s ease; display: inline-block; }
        .mobile-menu-btn.is-active span { transform: rotate(90deg); }

        @media screen and (max-width: 1024px) {
            .sidebar { position: fixed; left: 0; top: 0; transform: translateX(-100%); height: 100%; width: 85%; max-width: 380px; }
            .sidebar.active { transform: translateX(0); box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
            .mobile-menu-btn { display: flex; }
            .log-row { width: calc(100% - 20px); padding: 15px 15px 15px 55px; margin: 0 10px; min-height: 160px; }
            .col-select { left: 8px; }
            .guide-grid { grid-template-columns: 1fr; }
            input, textarea, some_select { font-size: 16px !important; }
            .log-row { min-height: 130px; } 
             .del-btn { padding: 8px; margin-top: 8px; }
        }
    </style>
</head>
<body>

    <button id="menu-toggle" class="mobile-menu-btn">
        <span class="material-symbols-outlined">settings</span>
    </button>

    <aside class="sidebar">
        <div class="sidebar-scroll">
            <a href="index.html" class="back-link">
                <span class="material-symbols-outlined" style="font-size: 1rem;">arrow_back_ios</span>
                BACK TO TOOLBOX
            </a>

            <div class="ui-header">
                <span class="ui-brand">IKATOOLBOX</span>
                <div class="ui-title">LOG EDITOR</div>
            </div>

            <div class="control-group">
                <h2>1. „Éï„Ç°„Ç§„É´Ë™≠Ëæº</h2>
                <input type="file" id="logFile" accept=".html" style="display:none" onchange="processLog(this.files[0])">
                <div class="file-input-area" onclick="document.getElementById('logFile').click()">
                    <p style="font-size:0.75rem; color:var(--text-sub); margin:0;">HTML„Çí„Éâ„É≠„ÉÉ„Éó„Åô„Çã„Åã<br><span class="file-label">„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû</span></p>
                </div>
            </div>

            <div id="editorSettings" style="display:none;">
                <div id="groupPanel" class="group-panel">
                    <div id="selectionInfo" style="font-size: 0.65rem; font-weight: 900; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 8px;">ÈÅ∏Êäû„Åó„ÅüË°å„Çí„Åæ„Å®„ÇÅ„Å¶Êìç‰Ωú</div>
                    <div class="btn-wrap">
                        <button onclick="moveGroup(-1)"><span class="material-symbols-outlined">north</span> ‰∏ä„Å∏</button>
                        <button onclick="moveGroup(1)"><span class="material-symbols-outlined">south</span> ‰∏ã„Å∏</button>
                        <button onclick="groupAndMove()"><span class="material-symbols-outlined">low_priority</span> Ë©∞„ÇÅ„Å¶ÁßªÂãï</button>
                        <button onclick="deleteSelectedRows()" class="btn-delete"><span class="material-symbols-outlined">delete</span> ÂâäÈô§</button>
                        <button onclick="clearSelection()"><span class="material-symbols-outlined">close</span> ÂèñÊ∂à</button>
                    </div>
                </div>

                <div class="control-group">
                    <h2>2. „Çø„Ç§„Éà„É´Ë®≠ÂÆö</h2>
                    <p style="font-size:0.6rem; color:var(--text-sub); margin-bottom:4px;">„Çª„ÉÉ„Ç∑„Éß„É≥„Çø„Ç§„Éà„É´</p>
                    <input type="text" id="logTitleInput" placeholder="„Çª„ÉÉ„Ç∑„Éß„É≥„Çø„Ç§„Éà„É´">

                    <p style="font-size:0.6rem; color:var(--text-sub); margin-top:12px; margin-bottom:4px;">Êõ∏„ÅçÂá∫„Åó„Éï„Ç°„Ç§„É´Âêç</p>
                    <div class="input-with-extension">
                        <input type="text" id="fileNameInput" placeholder="export_log">
                        <span class="extension-label">.html</span>
                    </div>

                    <p style="font-size:0.6rem; color:var(--text-sub); margin-top:12px; margin-bottom:4px;">„Ç∑„Çπ„ÉÜ„É†Âêç („Éò„ÉÉ„ÉÄ„ÉºË°®Á§∫)</p>
                    <select id="systemSelect" class="style-select" style="width:100%; margin-bottom:6px; height:36px;" onchange="toggleCustomSystem(this.value)">
                        <option value="CALL OF CTHULHU 6th">Call of Cthulhu 6th</option>
                        <option value="CALL OF CTHULHU 7th">Call of Cthulhu 7th</option>
                        <option value="EMOKLORE">Emoklore</option>
                        <option value="CUSTOM" selected>„Åù„ÅÆ‰ªñÔºàËá™Áî±ÂÖ•ÂäõÔºâ</option>
                    </select>
                    <input type="text" id="customSystemInput" placeholder="„Ç∑„Çπ„ÉÜ„É†Âêç„ÇíÂÖ•Âäõ" value="LOG ARCHIVE">
                </div>

                <div class="control-group">
                    <h2>3. Ê§úÁ¥¢„ÉªÁΩÆÊèõ</h2>
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="Ê§úÁ¥¢„ÉØ„Éº„Éâ..." oninput="handleSearch()">
                        <div class="search-btns">
                            <button onclick="navSearch(-1)">Ââç„Å∏</button>
                            <button onclick="navSearch(1)">Ê¨°„Å∏</button>
                        </div>
                        <div style="margin-top:10px; border-top:1px solid #333; padding-top:10px;">
                            <input type="text" id="replaceInput" placeholder="ÁΩÆÊèõÂæå„ÅÆ„ÉØ„Éº„Éâ...">
                            <button onclick="handleReplace()" style="width:100%; margin-top:4px; padding:6px; background:var(--accent); border:none; color:#fff; font-size:0.65rem; border-radius:4px; font-weight:bold; cursor:pointer;">‰∏ÄÊã¨ÁΩÆÊèõ„ÇíÂÆüË°å</button>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <h2>4. „Ç≠„É£„É©„ÇØ„Çø„ÉºË®≠ÂÆö</h2>
                    <div id="charGrid"></div>
                </div>
                <div class="control-group">
                    <h2>5. „Çø„ÉñË£ÖÈ£æË®≠ÂÆö</h2>
                    <div id="tabStyleSettings"></div>
                </div>
            </div>
        </div>
        <div class="sidebar-footer">
            <button class="save-btn" id="downloadBtn" disabled onclick="exportLog()">HTML„ÇíÊõ∏„ÅçÂá∫„Åó</button>
        </div>
    </aside>

    <main class="main-content" id="mainScrollArea">
        <div id="emptyState">
            <div class="guide-container">
                <div class="guide-welcome">
                    <h1>‰Ωø„ÅÑÊñπ</h1>
                    <p>IKATOOL LOG EDITOR</p>
                </div>

                <div class="guide-grid">
                    <div class="guide-item">
                        <span class="material-symbols-outlined guide-icon">upload_file</span>
                        <div class="guide-text">
                            <b>1. „É≠„Ç∞„ÇíË™≠„ÅøËæº„ÇÄ</b>
                            <p>Â∑¶„Éë„Éç„É´„Åã„Çâ„Ç≥„Ç≥„Éï„Ç©„É™„Ç¢Á≠â„ÅÆHTML„É≠„Ç∞„ÇíÈÅ∏Êäû„Åó„Åæ„Åô„ÄÇ</p>
                        </div>
                    </div>
                    <div class="guide-item">
                        <span class="material-symbols-outlined guide-icon">palette</span>
                        <div class="guide-text">
                            <b>2. Ë¶ã„ÅüÁõÆ„ÇíÊï¥„Åà„Çã</b>
                            <p>ÂêçÂâç„ÄÅËâ≤„ÄÅ„Çø„Éñ„Åî„Å®„ÅÆË£ÖÈ£æ„Çπ„Çø„Ç§„É´„Çí‰∏ÄÊã¨„ÅßÂ§âÊõ¥ÂèØËÉΩ„Åß„Åô„ÄÇ</p>
                        </div>
                    </div>
                    <div class="guide-item">
                        <span class="material-symbols-outlined guide-icon">check_box</span>
                        <div class="guide-text">
                            <b>3. „Åæ„Å®„ÇÅ„Å¶Êìç‰Ωú</b>
                            <p>Â∑¶ÂÅ¥„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„ÅßË§áÊï∞Ë°å„ÇíÈÅ∏Êäû„Åó„ÄÅ‰∏ÄÊã¨ÁßªÂãï„ÇÑÂâäÈô§„ÅåË°å„Åà„Åæ„Åô„ÄÇ</p>
                        </div>
                    </div>
                    <div class="guide-item">
                        <span class="material-symbols-outlined guide-icon">shortcut</span>
                        <div class="guide-text">
                            <b>4. ÁõÆÊ¨°„Çí„Å§„Åë„Çã</b>
                            <p>„ÄåÁõÆÊ¨°„Äç„Å´„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂÖ•„Çå„Å¶ÂëΩÂêç„Åô„Çã„Å®„ÄÅÊõ∏„ÅçÂá∫„ÅóÂæå„ÅÆ„É≠„Ç∞„Å´„É™„É≥„ÇØ„Çí‰ΩúÊàê„Åó„Åæ„Åô„ÄÇ</p>
                        </div>
                    </div>
                    <div class="guide-item">
                        <span class="material-symbols-outlined guide-icon">find_replace</span>
                        <div class="guide-text">
                            <b>5. Ê§úÁ¥¢„Å®ÁΩÆÊèõ</b>
                            <p>ÁâπÂÆö„ÅÆ„ÉØ„Éº„Éâ„ÇíÊ§úÁ¥¢„Åó„ÄÅ„É≠„Ç∞ÂÖ®‰Ωì„Åã„Çâ‰∏ÄÊã¨„ÅßÊõ∏„ÅçÊèõ„Åà„Çâ„Çå„Åæ„Åô„ÄÇ</p>
                        </div>
                    </div>
                    <div class="guide-item">
                        <span class="material-symbols-outlined guide-icon">download</span>
                        <div class="guide-text">
                            <b>6. ‰øùÂ≠ò„Åô„Çã</b>
                            <p>„ÄåHTML„ÇíÊõ∏„ÅçÂá∫„Åó„Äç„Åß„ÄÅ„É≠„Ç∞„Çí‰øùÂ≠ò„Åß„Åç„Åæ„Åô„ÄÇ</p>
                        </div>
                    </div>
                </div>
            </div>
            <div style="font-family: 'Montserrat'; font-weight: 900; font-size: 1rem; letter-spacing: 0.3em; color: #222; margin-top: 20px;">PLEASE LOAD YOUR LOG FILE</div>
        </div>
        <div id="logEditor"></div>
    </main>

<script>
    let logData = []; 
    let charSettings = {}; 
    let tabStyleMap = {}; 
    let selectedIndices = [];
    let searchMatches = [];
    let currentSearchIdx = -1;
    let lastSelectedIndex = -1; // ‰∏ÄÊã¨ÈÅ∏ÊäûÁî®

    const STYLES = [
        { id: 'style-default', name: '„É°„Ç§„É≥' },
        { id: 'style-info', name: 'ÊÉÖÂ†±' },
        { id: 'style-secret', name: 'ÁßòÂåø' },
        { id: 'style-chat', name: 'ÈõëË´á(„Åù„ÅÆ‰ªñ)' }
    ];

    const menuBtn = document.getElementById('menu-toggle');
    const sidebar = document.querySelector('.sidebar');
    menuBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        sidebar.classList.toggle('active');
        menuBtn.classList.toggle('is-active');
        const icon = menuBtn.querySelector('.material-symbols-outlined');
        icon.textContent = sidebar.classList.contains('active') ? 'close' : 'settings';
    });

    function toggleCustomSystem(val) {
        const input = document.getElementById('customSystemInput');
        input.style.display = val === 'CUSTOM' ? 'block' : 'none';
    }

    function rgbToHex(rgb) {
        if (!rgb || rgb.startsWith('#')) return rgb || '#DBDEE1';
        const parts = rgb.match(/\d+/g);
        if (!parts) return '#DBDEE1';
        return "#" + parts.slice(0,3).map(x => parseInt(x).toString(16).padStart(2, '0')).join('').toUpperCase();
    }

    function getCharKey(name, color) {
        return btoa(encodeURIComponent(name + color)).replace(/=/g, "");
    }

    async function processLog(file) {
        if (!file) return;
        logData = []; charSettings = {}; tabStyleMap = {}; selectedIndices = []; lastSelectedIndex = -1;
        const text = await file.text();
        const doc = new DOMParser().parseFromString(text, 'text/html');
        const baseTitle = file.name.replace('.html', '').replace(/\[all\]/gi, '').trim();
        document.getElementById('logTitleInput').value = baseTitle;
        document.getElementById('fileNameInput').value = baseTitle;

	doc.querySelectorAll('p').forEach((p) => {
            const htmlWithNewlines = p.innerHTML.replace(/<br\s*\/?>/gi, '\n');
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlWithNewlines;
            const match = tempDiv.innerText.match(/\[(.*?)\]\s*(.*?)\s*:\s*([\s\S]*)/); 
            
            if (!match) return;
            let [_, tabRaw, name, content] = match;            
            content = content.trim();
            if (!content) return;

            const tab = tabRaw.replace(/\(.*\)|Ôºà.*Ôºâ/g, "").trim();
            const color = rgbToHex(p.style.color);
            const charKey = getCharKey(name, color);
            logData.push({ charKey, content, tab, anchor: '' });
            if (!tabStyleMap[tab]) {
                let defaultColor = '#333333'; 
                let style = 'style-chat';     
                
                if (tab.match(/info|ÊÉÖÂ†±|system/i)) { 
                    style = 'style-info'; 
                    defaultColor = '#444444'; 
                } else if (tab.match(/ÁßòÂåø|ÁßòÂØÜ|HO/i)) { 
                    style = 'style-secret'; 
                    defaultColor = '#8e44ad'; 
                } else if (tab.match(/main|„É°„Ç§„É≥/i)) {
                    style = 'style-default';
                    defaultColor = '#C5373C';
                }
                
                tabStyleMap[tab] = { style, color: defaultColor };
            }
            if (!charSettings[charKey]) charSettings[charKey] = { displayName: name, color: color };
        });

        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('editorSettings').style.display = 'block';
        document.getElementById('downloadBtn').disabled = false;
        renderCharConfigs(); renderTabSettings(); renderEditor(true);
    }

    function renderCharConfigs() {
        const container = document.getElementById('charGrid');
        container.innerHTML = '';
        Object.keys(charSettings).forEach(key => {
            const div = document.createElement('div');
            div.className = 'char-conf';
            div.innerHTML = `
                <input type="color" class="in-color-picker" value="${charSettings[key].color}" oninput="charSettings['${key}'].color=this.value.toUpperCase(); this.nextElementSibling.nextElementSibling.value=this.value.toUpperCase(); updateAllRowColors('${key}')">
                <input type="text" class="in-name" value="${charSettings[key].displayName}" oninput="charSettings['${key}'].displayName=this.value; updateAllRowNames('${key}')">
                <input type="text" class="in-color" value="${charSettings[key].color}" oninput="if(/^#[0-9A-F]{6}$/i.test(this.value)){charSettings['${key}'].color=this.value.toUpperCase(); this.previousElementSibling.previousElementSibling.value=this.value; updateAllRowColors('${key}')}">
            `;
            container.appendChild(div);
        });
    }

    function updateAllRowColors(key) {
        const color = charSettings[key].color;
        document.querySelectorAll(`.row-name[data-charkey="${key}"]`).forEach(el => el.style.color = color);
    }
    function updateAllRowNames(key) {
        const name = charSettings[key].displayName;
        document.querySelectorAll(`.row-name[data-charkey="${key}"]`).forEach(el => {
            const tabEl = el.querySelector('small');
            const tab = tabEl ? tabEl.innerText : '';
            el.innerHTML = `${name} <small style="color:#444; font-size:0.6rem;">${tab}</small>`;
        });
    }

    function renderTabSettings() {
        const container = document.getElementById('tabStyleSettings');
        container.innerHTML = '';
        Object.keys(tabStyleMap).forEach(tab => {
            const div = document.createElement('div');
            div.className = 'tab-config-item';
            div.innerHTML = `
                <div class="tab-config-top">
                    <span class="tab-config-name">${tab}</span>
                    <div class="tab-config-controls">
                        <input type="color" class="in-color-picker" value="${tabStyleMap[tab].color}" oninput="tabStyleMap['${tab}'].color=this.value; updatePreviewStyles()">
                        <select class="style-select" onchange="tabStyleMap['${tab}'].style=this.value; updatePreviewStyles()">
                            ${STYLES.map(s => `<option value="${s.id}" ${tabStyleMap[tab].style === s.id ? 'selected' : ''}>${s.name}</option>`).join('')}
                        </select>
                    </div>
                </div>
            `;
            container.appendChild(div);
        });
        updatePreviewStyles();
    }

    function updatePreviewStyles() {
        logData.forEach((item, index) => {
            const row = document.getElementById(`row-${index}`);
            if(!row) return;
            row.classList.remove('preview-info', 'preview-secret', 'preview-chat');
            const styleObj = tabStyleMap[item.tab];
            if(styleObj.style === 'style-info') row.classList.add('preview-info');
            if(styleObj.style === 'style-secret') row.classList.add('preview-secret');
            if(styleObj.style === 'style-chat') row.classList.add('preview-chat');
        });
    }

function renderEditor(fullInit = false) {
        const container = document.getElementById('logEditor');
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        searchMatches = [];
        if (fullInit) {
            container.innerHTML = '';
            const fragment = document.createDocumentFragment();
            logData.forEach((item, index) => {
                const char = charSettings[item.charKey] || { displayName: "Unknown", color: "#888" };
                const row = document.createElement('div');
                row.className = `log-row`;
                row.id = `row-${index}`;
                row.innerHTML = `
                    <div class="row-header">
                        <span class="row-name" data-charkey="${item.charKey}" style="color:${char.color}">${char.displayName} <small style="color:#444; font-size:0.6rem;">[${item.tab}]</small></span>
                        <div class="anchor-area">
                            <label class="anchor-check-label">
                                <input type="checkbox" class="anchor-check" ${item.anchor ? 'checked' : ''} onchange="toggleAnchor(${index}, this.checked)">ÁõÆÊ¨°
                                <input type="text" class="anchor-input" value="${item.anchor || ''}" placeholder="ÁõÆÊ¨°Âêç„ÇíÂÖ•Âäõ" oninput="logData[${index}].anchor=this.value" style="${item.anchor ? 'display:block' : ''}">
                            </label>
                        </div>
                    </div>
                    <textarea class="row-content" oninput="logData[${index}].content = this.value; this.style.height='auto'; this.style.height=this.scrollHeight+'px'">${item.content}</textarea>
                    <div class="col-select">
                        <input type="checkbox" id="check-${index}" class="row-checkbox" onchange="toggleSelect(${index})" ${selectedIndices.includes(index) ? 'checked' : ''}>
                        <label for="check-${index}" class="select-label">Select</label>
                        <div class="action-group">
                            <button class="move-btn" onclick="moveRow(${index}, -1)" title="‰∏ä„Å´ÁßªÂãï"><span class="material-symbols-outlined">keyboard_arrow_up</span></button>
                            <button class="move-btn" onclick="moveRow(${index}, 1)" title="‰∏ã„Å´ÁßªÂãï"><span class="material-symbols-outlined">keyboard_arrow_down</span></button>
                            <button class="del-btn" onclick="deleteRow(${index})" title="ÂâäÈô§"><span class="material-symbols-outlined">delete</span></button>
                        </div>
                    </div>
                `;
                fragment.appendChild(row);
            });
            container.appendChild(fragment);
            container.querySelectorAll('textarea').forEach(ta => { ta.style.height = 'auto'; ta.style.height = ta.scrollHeight + 'px'; });
            updatePreviewStyles();
        }
        logData.forEach((item, index) => {
            const row = document.getElementById(`row-${index}`);
            if(!row) return;
            const isSelected = selectedIndices.includes(index);
            const isHit = searchTerm && item.content.toLowerCase().includes(searchTerm);
            if (isHit) searchMatches.push(index);
            row.classList.toggle('selected', isSelected);
            row.classList.toggle('search-hit', isHit);
            const cb = row.querySelector('.row-checkbox');
            if(cb) cb.checked = isSelected;
        });
    }

    function toggleSelect(index) {
        const targetTab = logData[index].tab;
        const pos = selectedIndices.indexOf(index);
        
        if (pos > -1) {
            selectedIndices.splice(pos, 1);
            lastSelectedIndex = -1;
        } else {
            if (lastSelectedIndex !== -1 && lastSelectedIndex < index) {
                for (let i = lastSelectedIndex; i <= index; i++) {
                    if (logData[i].tab === targetTab) {
                        if (!selectedIndices.includes(i)) {
                            selectedIndices.push(i);
                        }
                    }
                }
            } else {
                selectedIndices.push(index);
            }
            lastSelectedIndex = index;
        }

        const panel = document.getElementById('groupPanel');
        panel.style.display = selectedIndices.length > 0 ? 'block' : 'none';
        document.getElementById('selectionInfo').innerText = `${selectedIndices.length}‰ª∂„ÇíÈÅ∏Êäû‰∏≠`;
        renderEditor();
    }

    function deleteRow(index) {
        if (!confirm("„Åì„ÅÆË°å„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) return;
        logData.splice(index, 1);
        renderEditor(true);
    }

    function deleteSelectedRows() {
        if (selectedIndices.length === 0) return;
        if (!confirm(`${selectedIndices.length}‰ª∂„ÅÆË°å„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) return;
        const remainingData = [];
        const movingSet = new Set(selectedIndices);
        for (let i = 0; i < logData.length; i++) {
            if (!movingSet.has(i)) remainingData.push(logData[i]);
        }
        logData = remainingData;
        selectedIndices = [];
        lastSelectedIndex = -1;
        document.getElementById('groupPanel').style.display = 'none';
        renderEditor(true);
    }

    function moveRow(index, direction) {
        const newIndex = index + direction;
        if (newIndex < 0 || newIndex >= logData.length) return;
        const container = document.getElementById('logEditor');
        const rowA = document.getElementById(`row-${index}`);
        const rowB = document.getElementById(`row-${newIndex}`);
        if (direction === 1) container.insertBefore(rowB, rowA);
        else container.insertBefore(rowA, rowB);
        rowA.id = `row-temp`;
        rowB.id = `row-${index}`;
        rowA.id = `row-${newIndex}`;
        updateRowIndex(rowA, newIndex);
        updateRowIndex(rowB, index);
        const temp = logData[index];
        logData[index] = logData[newIndex];
        logData[newIndex] = temp;
        if (selectedIndices.includes(index)) {
            selectedIndices = selectedIndices.map(i => i === index ? newIndex : (i === newIndex ? index : i));
        } else if (selectedIndices.includes(newIndex)) {
            selectedIndices = selectedIndices.map(i => i === newIndex ? index : i);
        }
    }

    function updateRowIndex(row, newIdx) {
        row.querySelector('.row-checkbox').setAttribute('onchange', `toggleSelect(${newIdx})`);
        const btns = row.querySelectorAll('.move-btn');
        btns[0].setAttribute('onclick', `moveRow(${newIdx}, -1)`);
        btns[1].setAttribute('onclick', `moveRow(${newIdx}, 1)`);
        row.querySelector('.del-btn').setAttribute('onclick', `deleteRow(${newIdx})`);
        const anchorCheck = row.querySelector('.anchor-check');
        if(anchorCheck) anchorCheck.setAttribute('onchange', `toggleAnchor(${newIdx}, this.checked)`);
        const anchorInput = row.querySelector('.anchor-input');
        if(anchorInput) anchorInput.setAttribute('oninput', `logData[${newIdx}].anchor=this.value`);
        row.querySelector('.row-content').setAttribute('oninput', `logData[${newIdx}].content = this.value; this.style.height='auto'; this.style.height=this.scrollHeight+'px'`);
    }

    function moveGroup(direction) {
        if (selectedIndices.length === 0) return;
        selectedIndices.sort((a, b) => a - b);
        if (direction === -1 && selectedIndices[0] === 0) return;
        if (direction === 1 && selectedIndices[selectedIndices.length - 1] === logData.length - 1) return;
        const loopRange = direction === -1 ? selectedIndices : [...selectedIndices].reverse();
        loopRange.forEach(idx => moveRow(idx, direction));
    }

    function groupAndMove() {
        if (selectedIndices.length === 0) return;
        selectedIndices.sort((a, b) => a - b);
        const targetIdx = selectedIndices[0];
        const movingItems = selectedIndices.map(i => logData[i]);
        const newData = []; const movingSet = new Set(selectedIndices);
        for (let i = 0; i < logData.length; i++) {
            if (i === targetIdx) newData.push(...movingItems);
            if (!movingSet.has(i)) newData.push(logData[i]);
        }
        logData = newData; 
        selectedIndices = Array.from({length: movingItems.length}, (_, i) => targetIdx + i);
        renderEditor(true);
    }

    function clearSelection() { selectedIndices = []; lastSelectedIndex = -1; document.getElementById('groupPanel').style.display = 'none'; renderEditor(); }

    function toggleAnchor(index, checked) { if (!checked) logData[index].anchor = ''; }
    function handleSearch() { currentSearchIdx = -1; renderEditor(); }
    function navSearch(dir) {
        if (searchMatches.length === 0) return;
        currentSearchIdx = (currentSearchIdx + dir + searchMatches.length) % searchMatches.length;
        const targetId = `row-${searchMatches[currentSearchIdx]}`;
        document.getElementById(targetId).scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

function handleReplace() {
        const search = document.getElementById('searchInput').value;
        const replace = document.getElementById('replaceInput').value;
        if (!search) return;
        if (!confirm(`„Äå${search}„Äç„Çí„Åô„Åπ„Å¶„Äå${replace}„Äç„Å´ÁΩÆÊèõ„Åó„Åæ„Åô„ÅãÔºü`)) return;
        
        let changedCount = 0;

        logData.forEach((item, index) => {
            if (item.content.includes(search)) {
                item.content = item.content.split(search).join(replace);
                
                const row = document.getElementById(`row-${index}`);
                if (row) {
                    const ta = row.querySelector('.row-content');
                    ta.value = item.content;
                    ta.style.height = 'auto';
                    ta.style.height = ta.scrollHeight + 'px';
                    changedCount++;
                }
            }
        });

        if (changedCount > 0) {
        }
    }

function exportLog() {
        const h1Title = document.getElementById('logTitleInput').value || 'LOG';
        const fileName = document.getElementById('fileNameInput').value || 'log';
        const systemSelectVal = document.getElementById('systemSelect').value;
        const headerTitle = systemSelectVal === 'CUSTOM' ? 
            document.getElementById('customSystemInput').value || 'LOG ARCHIVE' : 
            systemSelectVal;

        const hexToRgba = (hex, alpha) => {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        };

        let customTabStyles = "";
        Object.keys(tabStyleMap).forEach(tabName => {
            const config = tabStyleMap[tabName];
            const safeName = btoa(encodeURIComponent(tabName)).replace(/=/g, "");
            const mainColor = config.color;
            if (config.style === 'style-secret') {
                const bgColor = hexToRgba(mainColor, 0.12);
                customTabStyles += `.tab-custom-${safeName} { background: ${bgColor} !important; border-left: 3px solid ${mainColor} !important; margin: 10px 15px; padding: 15px 20px; border-radius: 4px; } .tab-custom-${safeName} .row-name::before { background: ${mainColor} !important; }`;
            } else if (config.style === 'style-info') {
                customTabStyles += `.tab-custom-${safeName} { background: var(--block-bg); margin: 30px 15px; padding: 25px; border-radius: 4px; border: 1px solid #222; } .tab-custom-${safeName} .row-name::before { background: ${mainColor} !important; }`;
            }
        });

        let html = `<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>${h1Title}</title><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet"><style>:root { --outer-bg: #0f0f0f; --inner-bg: #050505; --block-bg: #111111; --text: #dbdee1; --accent: #C5373C; --sub-line: #444; --border: #222; --tab-text: #666; --chat-text: #8a8a8a; --container-width: 680px; } body { background: var(--outer-bg); color: var(--text); font-family: 'Noto Sans JP', sans-serif; margin: 0; padding: 0; line-height: 1.7; display: flex; flex-direction: column; align-items: center; } header { position: sticky; top: 0; width: 100%; background: rgba(5, 5, 5, 0.9); backdrop-filter: blur(12px); z-index: 1000; padding: 12px 0; border-bottom: 1px solid var(--border); display: flex; justify-content: center; } .header-inner { width: 90%; max-width: var(--container-width); display: flex; justify-content: space-between; align-items: center; } .header-title { font-family: 'Montserrat'; font-weight: 900; font-size: 0.85rem; color: #fff; letter-spacing: 0.2em; text-transform: uppercase; } #nav-drawer { position: relative; } .nav-uncheck { display: none; } .nav-open { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; background: var(--accent); border-radius: 4px; position: relative; } .nav-open span, .nav-open span:before, .nav-open span:after { content: ''; display: block; height: 2px; width: 16px; background: #fff; position: absolute; transition: 0.3s; } .nav-open span:before { top: -6px; } .nav-open span:after { bottom: -6px; } .nav-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); opacity: 0; visibility: hidden; transition: 0.3s; z-index: 1500; } .nav-uncheck:checked ~ .nav-overlay { opacity: 1; visibility: visible; } .nav-content { position: fixed; top: 0; right: -300px; width: 280px; height: 100vh; background: #0a0a0a; transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1); z-index: 2000; border-left: 1px solid #222; overflow-y: auto; } .nav-uncheck:checked ~ .nav-content { right: 0; } .nav-section { padding: 30px 20px 10px; border-bottom: 1px solid #222; } .nav-label { font-family: 'Montserrat'; font-weight: 900; font-size: 0.6rem; color: var(--accent); margin-bottom: 15px; display: block; } .filter-btn { display: inline-block; padding: 6px 12px; margin: 4px; font-size: 0.7rem; font-weight: bold; background: #1a1a1a; border: 1px solid #333; border-radius: 20px; color: #888; cursor: pointer; transition: 0.2s; } .filter-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); } .index-link { display: block; color: #ccc; text-decoration: none; padding: 15px 20px; font-size: 0.8rem; border-bottom: 1px solid #1a1a1a; } .container { width: 100%; max-width: var(--container-width); background: var(--inner-bg); min-height: 100vh; padding: 0 0 100px; box-shadow: 0 0 50px rgba(0,0,0,0.5); } .hidden { display: none !important; }
        .log-row { padding: 12px 25px; border-bottom: 1px dashed #1a1a1a; }
        .row-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .style-info 
        .row-header { padding-bottom: 6px; border-bottom: 1px solid #333; margin-bottom: 10px; } 
        .row-name { font-weight: 900; font-size: 0.85rem; color: #fff; display: flex; align-items: center; gap: 8px; }
        .row-name::before { display: none; } .name-line { width: 3px; height: 1em; background: var(--sub-line); } 
        .row-tab { font-family: 'Montserrat'; font-weight: 700; font-size: 0.55rem; color: var(--tab-text); text-transform: uppercase; } 
        .row-content { font-size: 0.95rem; color: #ccc; white-space: pre-wrap; line-height: 1.7; } 
        .hero-title-area { padding: 40px 25px 25px; text-align: left; border-bottom: 1px solid #111; }
        .hero-brand { font-family: 'Montserrat'; font-size: 0.6rem; font-weight: 900; color: var(--accent); letter-spacing: 0.5em; display: block; margin-bottom: 8px; } 
        .hero-title { font-family: 'Montserrat', 'Noto Sans JP'; font-size: 1.5rem; font-weight: 900; color: #fff; line-height: 1.3; border-left: 3px solid var(--accent); padding-left: 15px; }
        .style-chat { margin-left: 10%; border-left: 1px solid #222; padding: 10px 15px; opacity: 0.8; } 
        .style-chat .row-content { color: var(--chat-text); font-size: 0.85rem; } 
        .row-system { padding: 2.2em 25px !important; opacity: 0.8; } 
        .row-system .row-header { display: none; } 
        .row-system 
        .row-content { font-style: italic; color: #aaa; text-align: left; margin: 0; } ${customTabStyles} footer { text-align: center; padding: 80px; font-family: 'Montserrat'; font-size: 0.6rem; opacity: 0.2; } [id^="log-"] { scroll-margin-top: 80px; }</style></head><body><header><div class="header-inner"><div class="header-title">${headerTitle}</div><nav id="nav-drawer"><input id="nav-input" type="checkbox" class="nav-uncheck"><label for="nav-input" class="nav-overlay"></label><label for="nav-input" class="nav-open"><span></span></label><div class="nav-content"><div class="nav-section"><span class="nav-label">FILTER</span><div id="filter-container"><button class="filter-btn active" onclick="toggleTab('style-default', this)">MAIN</button><button class="filter-btn active" onclick="toggleTab('style-info', this)">INFO</button><button class="filter-btn active" onclick="toggleTab('style-secret', this)">SECRET</button><button class="filter-btn active" onclick="toggleTab('style-chat', this)">CHAT</button></div></div><div class="nav-section" style="border:none;"><span class="nav-label">INDEX</span><div id="index-list">`;
        logData.forEach((item, i) => { if (item.anchor) html += `<a href="#log-${i}" class="index-link" onclick="closeMenu()">${item.anchor}</a>`; });
        html += `</div></div></div></nav></div></header><div class="container"><div class="hero-title-area"><span class="hero-brand">SESSION LOG</span><div class="hero-title">${h1Title}</div></div>`;
        logData.forEach((item, i) => {
            const char = charSettings[item.charKey];
            const config = tabStyleMap[item.tab];
            const safeName = btoa(encodeURIComponent(item.tab)).replace(/=/g, "");
            let styleClass = config.style;
            if (config.style === 'style-secret' || config.style === 'style-info') styleClass += ` tab-custom-${safeName}`;
            
            const isSystem = (char.displayName && char.displayName.toLowerCase() === 'system') || (item.charKey && item.charKey.toLowerCase() === 'system');
            if (isSystem) {
                styleClass += ' row-system';
            }

            let nameStyle = "";
            let lineStyle = "";
            if (config.style === 'style-chat') {
                nameStyle = `style="color:${char.color}"`;
                lineStyle = `style="display:none;"`;
            } else {
                lineStyle = `style="background:${char.color}"`;
            }

            html += `<div class="log-row ${styleClass}" id="log-${i}" data-tab="${config.style}"><div class="row-header"><div class="row-name" ${nameStyle}><span class="name-line" ${lineStyle}></span>${char.displayName}</div><div class="row-tab">${item.tab}</div></div><div class="row-content">${item.content.replace(/\n/g, '<br>')}</div></div>`;
        });
        html += `</div><footer>‚ú¶ IKATOOLBOX</footer><script>function closeMenu() { document.getElementById('nav-input').checked = false; } function toggleTab(tabClass, btn) { btn.classList.toggle('active'); const rows = document.querySelectorAll('[data-tab="' + tabClass + '"]'); rows.forEach(row => { if (btn.classList.contains('active')) { row.classList.remove('hidden'); } else { row.classList.add('hidden'); } }); }<\/script></body></html>`;

        const blob = new Blob([html], { type: 'text/html' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = fileName + ".html"; a.click();
    }
</script>

<div style="position: fixed; bottom: 10px; right: 15px; font-family: sans-serif; font-size: 10px; color: rgba(255,255,255,0.1); letter-spacing: 0.1em; font-weight: bold; pointer-events: none; z-index: 9999;">‚ú¶ IKATOOLBOX</div>
</body>
</html>
